
# ğŸ“˜ Reservation Snapshot Schema & Triggers èªªæ˜

## ğŸ§© æ¦‚è¿°

æ­¤è¨­è¨ˆç‚º **é ç´„ç³»çµ±ï¼ˆreservation systemï¼‰** çš„ä¸€éƒ¨åˆ†ï¼Œ
é€é **MariaDB/MySQL è§¸ç™¼å™¨ï¼ˆTriggersï¼‰** è‡ªå‹•ç”¢ç”Ÿã€Œé ç´„å¿«ç…§ï¼ˆreservation snapshotï¼‰ã€è¨˜éŒ„ã€‚

ç•¶é ç´„é€²å…¥æœ€çµ‚ç‹€æ…‹ï¼ˆå®Œæˆã€è¢«æ‹’ã€å–æ¶ˆã€ä»˜æ¬¾å¤±æ•—ç­‰ï¼‰æ™‚ï¼Œ
ç³»çµ±æœƒè‡ªå‹•å°‡ç•¶å‰è³‡æ–™å¯«å…¥ `reservation_record` è¡¨ä¸­ï¼Œä»¥ä¾¿ï¼š

* ä¿ç•™æ­·å²ç´€éŒ„
* ç¨½æ ¸è¿½è¹¤
* é˜²æ­¢é—œéµè³‡æ–™éºå¤±

---

## âš™ï¸ ç³»çµ±æ¶æ§‹

| å…ƒä»¶                   | èªªæ˜                       |
| -------------------- | ------------------------ |
| `reservation`        | ä¸»è¡¨ï¼Œç”¨æ–¼å„²å­˜ç›®å‰çš„é ç´„è³‡æ–™ï¼ˆæœƒéš¨ç‹€æ…‹æ›´æ–°ï¼‰ã€‚  |
| `users`              | ä½¿ç”¨è€…è³‡æ–™ä¾†æºï¼Œè§¸ç™¼å™¨æœƒå¾ä¸­å–å‡ºä½¿ç”¨è€…è¯çµ¡è³‡è¨Šã€‚ |
| `reservation_record` | å¿«ç…§è¡¨ï¼Œç”¨æ–¼å„²å­˜é ç´„æœ€çµ‚ç‹€æ…‹çš„æ­·å²ç´€éŒ„ã€‚     |

---

## ğŸ” é‹ä½œé‚è¼¯

### ğŸ¯ è§¸ç™¼æ¢ä»¶

ç•¶ä»»ä¸€æ¢ä»¶æˆç«‹æ™‚è§¸ç™¼å¿«ç…§å¯«å…¥ï¼š

```sql
NEW.reservation_status = 1
OR NEW.review_status IN ('rejected', 'canceled')
OR NEW.payment_status IN ('failed', 'refunded')
```

å³ä»£è¡¨ï¼š

* âœ… é ç´„å®Œæˆ (`reservation_status = 1`)
* âŒ è¢«æ‹’çµ•æˆ–å–æ¶ˆ
* ğŸ’¸ ä»˜æ¬¾å¤±æ•—æˆ–é€€æ¬¾

---

## ğŸ§  è§¸ç™¼å™¨èªªæ˜

### ğŸŸ¢ `AFTER INSERT` â€” `trg_reservation_snapshot_ai`

> ç•¶æ–°å¢ä¸€ç­†é ç´„æ™‚åŸ·è¡Œã€‚

è‹¥è©²ç­†é ç´„åœ¨æ–°å¢æ™‚å°±å·²é€²å…¥æœ€çµ‚ç‹€æ…‹ï¼ˆä¾‹å¦‚å–æ¶ˆæˆ–ä»˜æ¬¾å¤±æ•—ï¼‰ï¼Œ
å‰‡ç«‹å³å°‡å…¶å¿«ç…§å¯«å…¥ `reservation_record`ã€‚

---

### ğŸŸ¡ `AFTER UPDATE` â€” `trg_reservation_snapshot_au`

> ç•¶ä¿®æ”¹é ç´„ç‹€æ…‹æ™‚åŸ·è¡Œã€‚

è‹¥æ›´æ–°å¾Œçš„é ç´„è®Šç‚ºæœ€çµ‚ç‹€æ…‹ï¼Œ
å‰‡æœƒå°‡è©²ç­†é ç´„çš„æœ€æ–°è³‡æ–™å¯«å…¥ï¼ˆæˆ–è¦†è“‹ï¼‰å¿«ç…§è¡¨ã€‚

---

## ğŸ“¦ å¿«ç…§å¯«å…¥å…§å®¹

æ¯ç•¶è§¸ç™¼å™¨è¢«å•Ÿå‹•ï¼Œæœƒå°‡ä¸‹åˆ—æ¬„ä½å­˜å…¥ `reservation_record`ï¼š

| é¡åˆ¥     | æ¬„ä½                                                                         |
| ------ | -------------------------------------------------------------------------- |
| é ç´„åŸºæœ¬è³‡æ–™ | `reservation_id`, `user_id`, `booking_time`, `booking_number`              |
| èµ·è¨–ç«™é»   | `booking_start_station_name`, `booking_end_station_name`                   |
| ä½¿ç”¨è€…è³‡æ–™  | `line_id`, `username`, `email`, `phone`                                    |
| ç‹€æ…‹æ¬„ä½   | `payment_status`, `review_status`, `dispatch_status`, `reservation_status` |
| å…¶ä»–     | `payment_method`, `payment_record`, `cancel_reason`, `snapshot_date`       |

> `snapshot_date` ä½¿ç”¨ `CURDATE()` è‡ªå‹•å¡«å…¥å¿«ç…§æ—¥æœŸã€‚

---

## ğŸ” `ON DUPLICATE KEY UPDATE`

```sql
ON DUPLICATE KEY UPDATE ...
```

é€™å¥ç¢ºä¿ï¼š

* è‹¥åŒä¸€ç­† `reservation_id` å·²å­˜åœ¨æ–¼ `reservation_record`ï¼Œ
  å°±ä¸æ–°å¢ï¼Œè€Œæ˜¯æ›´æ–°æˆæœ€æ–°ç‹€æ…‹ã€‚
* ä¿è­‰æ¯ç­†é ç´„åœ¨å¿«ç…§è¡¨ä¸­åƒ…æœ‰ä¸€æ¢æœ€çµ‚ç´€éŒ„ã€‚

> âš ï¸ å› æ­¤ `reservation_record.reservation_id` æ‡‰è¨­ç‚º **PRIMARY KEY** æˆ– **UNIQUE KEY**ã€‚


## âš ï¸ æ³¨æ„äº‹é …

1. **ç¢ºä¿å”¯ä¸€éµï¼š**
   `reservation_record.reservation_id` å¿…é ˆç‚º `PRIMARY KEY` æˆ– `UNIQUE`ï¼Œå¦å‰‡ `ON DUPLICATE KEY UPDATE` ç„¡æ•ˆã€‚
2. **ä½¿ç”¨è€…è³‡æ–™å®‰å…¨ï¼š**
   è‹¥ `user_id` ç‚º NULLï¼Œè§¸ç™¼å™¨æœƒå°‡ `line_id`ã€`username`ã€`email`ã€`phone` è¨­ç‚º `NULL`ã€‚
3. **æ•ˆèƒ½è€ƒé‡ï¼š**
   è‹¥ç³»çµ±é ç´„æ›´æ–°é »ç¹ï¼Œè«‹è©•ä¼°è§¸ç™¼å™¨å°æ€§èƒ½çš„å½±éŸ¿ã€‚
4. **æ™‚é–“æ¬„ä½å»ºè­°ï¼š**
   å¯æ–¼ `reservation_record` åŠ ä¸Š `snapshot_timestamp`ï¼ˆ`DEFAULT CURRENT_TIMESTAMP`ï¼‰ä»¥è¿½è¹¤å…·é«”å¯«å…¥æ™‚é–“ã€‚

---

## ğŸ§­ é‹ä½œæµç¨‹åœ–ï¼ˆç°¡åŒ–ï¼‰

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   INSERT / UPDATE  â”‚
â”‚   on reservation   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   Check final state?
   â”œâ”€â”€ reservation_status = 1
   â”œâ”€â”€ review_status âˆˆ (rejected, canceled)
   â””â”€â”€ payment_status âˆˆ (failed, refunded)
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fetch user info from users â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Write / Update snapshot in â”‚
â”‚     reservation_record      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§¾ ç¸½çµ

é€™çµ„è§¸ç™¼å™¨çš„ç›®çš„ï¼Œæ˜¯è®“é ç´„ç³»çµ±å…·å‚™ã€Œ**äº‹ä»¶å®Œæˆå¾Œè‡ªå‹•ç•™ç—•**ã€çš„èƒ½åŠ›ã€‚
ç„¡è«–æ˜¯ä»˜æ¬¾å¤±æ•—ã€è¢«æ‹’ã€å®Œæˆæˆ–å–æ¶ˆï¼Œéƒ½æœƒå³æ™‚ä¿å­˜ç•¶æ™‚çš„é ç´„èˆ‡ä½¿ç”¨è€…è³‡è¨Šï¼Œ
ç¢ºä¿ç³»çµ±èƒ½å¤ ï¼š

* é‚„åŸæ­·å²ç‹€æ…‹
* é€²è¡Œç¨½æ ¸èˆ‡åˆ†æ
* æå‡è³‡æ–™å®Œæ•´æ€§