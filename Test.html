<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è·¯ç·š + å…¬è»Šï¼ˆç¬¬äºŒç«™ï¼‰</title>

  <!-- Leafletï¼ˆç„¡ SRIï¼Œé¿å…ä½ çš„ç’°å¢ƒå‡ºç¾ integrity éŒ¯èª¤ï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ç®­é ­å¤–æ›ï¼ˆå¯æœ‰å¯ç„¡ï¼›è‹¥æŠ“ä¸åˆ°å°±åªç•«ä¸»ç·šï¼‰ -->
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.min.js"></script>

  <style>
    html,body{height:100%;margin:0;background:#0b0f14}
    #map{height:100%;width:100%}

    /* å…¬è»Šæ¨™è¨˜ï¼ˆè„ˆè¡ + é» + è²¼ç´™ï¼‰ */
    .bus-wrap{position:relative;transform:translate(-50%,-50%);pointer-events:none}
    .bus-pulse{
      position:absolute;left:50%;top:50%;width:66px;height:66px;border-radius:50%;
      transform:translate(-50%,-50%);background:rgba(37,99,235,.15);box-shadow:0 0 0 4px rgba(37,99,235,.12);
      animation:pulse 1.6s ease-out infinite
    }
    .bus-dot{
      position:absolute;left:50%;top:50%;width:18px;height:18px;border-radius:50%;
      transform:translate(-50%,-50%);background:#2563eb;border:2px solid #fff;box-shadow:0 4px 14px rgba(0,0,0,.35)
    }
    .bus-emoji{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      font-size:20px;text-shadow:0 2px 8px rgba(0,0,0,.35)
    }
    .bus-badge{
      position:absolute;left:50%;top:-8px;transform:translate(-50%,-100%);
      background:#111827;color:#fff;border-radius:999px;padding:3px 8px;font-weight:800;font-size:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.35)
    }
    @keyframes pulse{0%{transform:translate(-50%,-50%) scale(.6);opacity:.9}70%{opacity:.25}100%{transform:translate(-50%,-50%) scale(1.15);opacity:0}}

    /* ç«™é»å¾½ç« ï¼ˆS/1/2/.../çµ‚é»ï¼‰ */
    .stop-badge{
      background:#fff;color:#111;border:2px solid #2563eb;
      font-weight:800;min-width:22px;height:22px;border-radius:14px;line-height:18px;
      display:inline-flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,.15)
    }
    .stop-start{color:#2563eb;border-color:#2563eb}
    .stop-end{color:#d97706;border-color:#d97706}
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ===== 1) åˆå§‹åŒ–åœ°åœ–ï¼ˆNLSC WMTS åº•åœ–ï¼‰ =====
    const map = L.map("map", { center:[23.99302,121.603219], zoom:14 });
    L.tileLayer("https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}",
      { tileSize:256, attribution:"Leaflet | Â© NLSC WMTS | Â© OpenStreetMap" }).addTo(map);
    L.tileLayer("https://wmts.nlsc.gov.tw/wmts/EMAP2/default/GoogleMapsCompatible/{z}/{y}/{x}",
      { tileSize:256, opacity:.9 }).addTo(map);

    // é¡è‰²ä¸»é¡Œï¼ˆå°èˆªè—ï¼‰
    const theme = { casing:"#ffffff", stroke:"#2563eb" };

    const stopsLayer = L.layerGroup().addTo(map);
    const routeLayer = L.layerGroup().addTo(map);
    const busLayer   = L.layerGroup().addTo(map);

    const stopIcon = (label, cls="") => L.divIcon({className:"", html:`<div class="stop-badge ${cls}">${label}</div>`, iconSize:[24,24], iconAnchor:[12,12]});
    const makeBusIcon = () => L.divIcon({className:"", html:`
      <div class="bus-wrap">
        <div class="bus-pulse"></div>
        <div class="bus-dot"></div>
        <div class="bus-emoji">ğŸšŒ</div>
        <div class="bus-badge">BUS</div>
      </div>`, iconSize:[1,1]});

    function drawRoute(geojson){
      routeLayer.clearLayers();
      const casing = L.geoJSON(geojson, { style:{ color:theme.casing, weight:12, opacity:1, lineCap:"round", lineJoin:"round" }}).addTo(routeLayer);
      const stroke = L.geoJSON(geojson, { style:{ color:theme.stroke, weight:7, opacity:.98, lineCap:"round", lineJoin:"round" }}).addTo(routeLayer);

      // ç®­é ­ï¼ˆå¤–æ›å­˜åœ¨æ™‚æ‰ç•«ï¼‰
      const ok = !!(L&&L.polylineDecorator&&L.Symbol&&L.Symbol.arrowHead);
      const poly = stroke.getLayers()[0];
      if (ok && poly){
        L.polylineDecorator(poly, { patterns:[{
          offset:0, repeat:"48px",
          symbol:L.Symbol.arrowHead({pixelSize:11, pathOptions:{color:theme.stroke, weight:6, opacity:0.95}})
        }]}).addTo(routeLayer);
      }
      return stroke;
    }

    async function main(){
      // ===== 2) å– API ç«™é» =====
      const payload = { route_id: 1, direction: "å»ç¨‹" }; // ä¾ä½ çš„éœ€æ±‚æ›¿æ›
      const resp = await fetch("http://127.0.0.1:8500/Route_Stations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) throw new Error("API error: " + resp.status);
      const data = await resp.json();
      if (!Array.isArray(data) || data.length < 2) throw new Error("ç«™é»ä¸è¶³");

      // ç«™é» â†’ LatLng é™£åˆ—ï¼ˆä¾ stop_order æ’åºï¼‰
      data.sort((a,b)=> (a.stop_order||0) - (b.stop_order||0));

      // æ³¨æ„ï¼šè‹¥å…©å€‹ç«™é»åº§æ¨™ç›¸åŒï¼ˆä¾‹å¦‚ ç¬¬4ç«™èˆ‡ç¬¬8ç«™åŒåº§æ¨™ï¼‰ï¼Œ
      // é è¨­æ¨™è¨˜æœƒå®Œå…¨é‡ç–Šï¼Œçœ‹èµ·ä¾†åƒå°‘äº†ä¸€ç«™ã€‚
      // é€™è£¡å°é‡ç–Šé»åŠ ä¸Šæ¥µå°ä½ç§»ï¼ˆç´„ 4m çš„æ”¾å°„ç‹€ä½ç§»ï¼‰ï¼Œé¿å…å½¼æ­¤é®è“‹ã€‚
      const seen = new Map(); // key: lat,lng -> count
      const offsetLatLng = ([lat,lng], meters=4, angleDeg=0) => {
        const R=6378137;
        const dLat = (meters*Math.cos(angleDeg*Math.PI/180))/R;
        const dLng = (meters*Math.sin(angleDeg*Math.PI/180))/(R*Math.cos(lat*Math.PI/180));
        return [lat + dLat*180/Math.PI, lng + dLng*180/Math.PI];
      }

      const latlngs = data.map((s) => {
        const lat = Number(s.latitude), lng = Number(s.longitude);
        const key = lat.toFixed(6)+","+lng.toFixed(6);
        const dupIdx = (seen.get(key) || 0);
        seen.set(key, dupIdx+1);
        // æ”¾å¤§åç§»è·é›¢èˆ‡è§’åº¦æ­¥é€²ï¼Œç¢ºä¿å®Œå…¨åˆ†é›¢
        return dupIdx===0 ? [lat,lng] : offsetLatLng([lat,lng], dupIdx*14, dupIdx*45);
      });

      // ç•«ç«™é»æ¨™è¨˜ï¼ˆç”¨ stop_order ç•¶ç·¨è™Ÿï¼‰
      stopsLayer.clearLayers();
      data.forEach((s, i) => {
        const cls = i===0 ? "stop-start" : (i===data.length-1 ? "stop-end" : "");
        const label = i===0 ? "S" : (s.stop_order || i+1);
        L.marker(latlngs[i], { icon: stopIcon(label, cls) })
         .bindTooltip(`${s.stop_name}`, {permanent:false, direction:"top"})
         .addTo(stopsLayer);
      });

      for (const [k,c] of seen) { if (c>1) console.log('ç™¼ç¾é‡ç–Šåº§æ¨™ï¼Œå·²åç§»é¿å…é®è“‹ï¼š', k, 'æ¬¡æ•¸', c) }

      // ===== 3) å…¬è»Šæ”¾åœ¨ã€Œç¬¬äºŒç«™ã€ =====
      const second = data[1];
      busLayer.clearLayers();
      L.marker([second.latitude, second.longitude], { icon: makeBusIcon() }).addTo(busLayer);

      // ===== 4) ç”¨ OSRM å°‡æ‰€æœ‰ç«™é»ã€Œè²¼é“è·¯ã€æˆä¸€æ¢å°èˆªé¢¨æ ¼è·¯ç·š =====
      // æŠŠç«™é»é †åºä¸²æˆ coords
      const coords = latlngs.map(([lat,lng]) => `${lng},${lat}`).join(";");
      const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson&steps=false&annotations=distance,duration`;

      try {
        const r = await fetch(url); if(!r.ok) throw new Error(r.status);
        const j = await r.json(); if(!(j.routes && j.routes[0])) throw new Error("no route");
        const main = j.routes[0];
        const stroke = drawRoute(main.geometry);
        map.fitBounds(stroke.getBounds(), { padding:[40,40] });
      } catch(err){
        console.warn("OSRM è¦åŠƒå¤±æ•—ï¼Œé€€å›ç›´ç·š Polylineã€‚", err);
        // è‹¥ OSRM demo å¤ªå¿™ï¼Œé€€å›ç°¡å–®ç·šæ®µ
        const line = L.polyline(latlngs, { color: theme.stroke, weight: 6 }).addTo(routeLayer);
        map.fitBounds(line.getBounds(), { padding:[40,40] });
      }
    }

    main().catch(err=>{
      console.error(err);
      alert("è¼‰å…¥å¤±æ•—ï¼š" + err.message + "\\n\\næ³¨æ„ï¼šè‹¥æ˜¯æœ¬åœ°æª”æ¡ˆç›´é–‹ï¼Œè«‹ç¢ºä¿ API æœ‰é–‹æ”¾ CORSï¼Œæˆ–æ”¹ç”¨æœ¬æ©Ÿä¼ºæœå™¨å•Ÿå‹•æ­¤é ã€‚");
    });
  </script>
</body>
</html>
