TYPE=TRIGGERS
triggers='CREATE DEFINER=`root`@`%` TRIGGER `trg_reservation_snapshot_ai`\nAFTER INSERT ON `reservation`\nFOR EACH ROW\nBEGIN\n  DECLARE v_line_id VARCHAR(100);\n  DECLARE v_username VARCHAR(100);\n  DECLARE v_email VARCHAR(255);\n  DECLARE v_phone VARCHAR(20);\n\n  IF NEW.`reservation_status` = 1\n     OR NEW.`review_status` IN (\'rejected\',\'canceled\')\n     OR NEW.`payment_status` IN (\'failed\',\'refunded\') THEN\n\n    IF NEW.`user_id` IS NOT NULL THEN\n      SELECT `line_id`, `username`, `email`, `phone`\n        INTO v_line_id, v_username, v_email, v_phone\n      FROM `users`\n      WHERE `user_id` = NEW.`user_id`;\n    ELSE\n      SET v_line_id = NULL; SET v_username = NULL; SET v_email = NULL; SET v_phone = NULL;\n    END IF;\n\n    INSERT INTO `reservation_record` (\n      `reservation_id`, `user_id`, `line_id`, `username`, `email`, `phone`,\n      `booking_time`, `booking_number`, `booking_start_station_name`, `booking_end_station_name`,\n      `payment_method`, `payment_record`, `payment_status`, `review_status`, `dispatch_status`, `reservation_status`, `cancel_reason`, `snapshot_date`\n    )\n    VALUES (\n      NEW.`reservation_id`, NEW.`user_id`, v_line_id, v_username, v_email, v_phone,\n      NEW.`booking_time`, NEW.`booking_number`,\n      NEW.`booking_start_station_name`, NEW.`booking_end_station_name`,\n      NEW.`payment_method`, NEW.`payment_record`,\n      NEW.`payment_status`, NEW.`review_status`, NEW.`dispatch_status`, NEW.`reservation_status`, NEW.`cancel_reason`,\n      CURDATE()\n    )\n    ON DUPLICATE KEY UPDATE\n      `user_id` = VALUES(`user_id`),\n      `line_id` = VALUES(`line_id`),\n      `username` = VALUES(`username`),\n      `email` = VALUES(`email`),\n      `phone` = VALUES(`phone`),\n      `booking_time` = VALUES(`booking_time`),\n      `booking_number` = VALUES(`booking_number`),\n      `booking_start_station_name` = VALUES(`booking_start_station_name`),\n      `booking_end_station_name` = VALUES(`booking_end_station_name`),\n      `payment_method` = VALUES(`payment_method`),\n      `payment_record` = VALUES(`payment_record`),\n      `payment_status` = VALUES(`payment_status`),\n      `review_status` = VALUES(`review_status`),\n      `dispatch_status` = VALUES(`dispatch_status`),\n      `reservation_status` = VALUES(`reservation_status`),\n      `cancel_reason` = VALUES(`cancel_reason`);\n  END IF;\nEND' 'CREATE DEFINER=`root`@`%` TRIGGER `trg_reservation_snapshot_au`\nAFTER UPDATE ON `reservation`\nFOR EACH ROW\nBEGIN\n  DECLARE v_line_id VARCHAR(100);\n  DECLARE v_username VARCHAR(100);\n  DECLARE v_email VARCHAR(255);\n  DECLARE v_phone VARCHAR(20);\n\n  IF NEW.`reservation_status` = 1\n     OR NEW.`review_status` IN (\'rejected\',\'canceled\')\n     OR NEW.`payment_status` IN (\'failed\',\'refunded\') THEN\n\n    IF NEW.`user_id` IS NOT NULL THEN\n      SELECT `line_id`, `username`, `email`, `phone`\n        INTO v_line_id, v_username, v_email, v_phone\n      FROM `users`\n      WHERE `user_id` = NEW.`user_id`;\n    ELSE\n      SET v_line_id = NULL; SET v_username = NULL; SET v_email = NULL; SET v_phone = NULL;\n    END IF;\n\n    INSERT INTO `reservation_record` (\n      `reservation_id`, `user_id`, `line_id`, `username`, `email`, `phone`,\n      `booking_time`, `booking_number`, `booking_start_station_name`, `booking_end_station_name`,\n      `payment_method`, `payment_record`, `payment_status`, `review_status`, `dispatch_status`, `reservation_status`, `cancel_reason`, `snapshot_date`\n    )\n    VALUES (\n      NEW.`reservation_id`, NEW.`user_id`, v_line_id, v_username, v_email, v_phone,\n      NEW.`booking_time`, NEW.`booking_number`,\n      NEW.`booking_start_station_name`, NEW.`booking_end_station_name`,\n      NEW.`payment_method`, NEW.`payment_record`,\n      NEW.`payment_status`, NEW.`review_status`, NEW.`dispatch_status`, NEW.`reservation_status`, NEW.`cancel_reason`,\n      CURDATE()\n    )\n    ON DUPLICATE KEY UPDATE\n      `user_id` = VALUES(`user_id`),\n      `line_id` = VALUES(`line_id`),\n      `username` = VALUES(`username`),\n      `email` = VALUES(`email`),\n      `phone` = VALUES(`phone`),\n      `booking_time` = VALUES(`booking_time`),\n      `booking_number` = VALUES(`booking_number`),\n      `booking_start_station_name` = VALUES(`booking_start_station_name`),\n      `booking_end_station_name` = VALUES(`booking_end_station_name`),\n      `payment_method` = VALUES(`payment_method`),\n      `payment_record` = VALUES(`payment_record`),\n      `payment_status` = VALUES(`payment_status`),\n      `review_status` = VALUES(`review_status`),\n      `dispatch_status` = VALUES(`dispatch_status`),\n      `reservation_status` = VALUES(`reservation_status`),\n      `cancel_reason` = VALUES(`cancel_reason`);\n  END IF;\nEND'
sql_modes=1411383296 1411383296
definers='root@%' 'root@%'
client_cs_names='utf8mb4' 'utf8mb4'
connection_cl_names='utf8mb4_unicode_ci' 'utf8mb4_unicode_ci'
db_cl_names='utf8mb4_general_ci' 'utf8mb4_general_ci'
created=1760685876335828 1760685876554544
